<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epitome Collective - Professional Costing Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .mode-selector {
            background: rgba(102, 126, 234, 0.1);
            padding: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .mode-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 300px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .mode-card.active {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.2);
        }

        .mode-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .mode-card p {
            color: #666;
            font-size: 0.9rem;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 450px;
            min-height: 80vh;
        }

        .left-panel {
            padding: 40px;
            background: #f8f9ff;
        }

        .middle-panel {
            padding: 40px;
            background: #f0f8ff;
            border-left: 1px solid #e1e8ed;
            border-right: 1px solid #e1e8ed;
        }

        .right-panel {
            padding: 40px;
            background: white;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .section h3 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .budget-highlight {
            background: #e8f5e8 !important;
            border-color: #4CAF50 !important;
        }

        .cost-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .cost-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .cost-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .cost-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 8px;
            text-align: right;
            font-size: 14px;
            font-weight: 500;
        }

        .cost-table input:focus {
            outline: 2px solid #667eea;
            border-radius: 5px;
        }

        .total-row {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }

        .total-row td {
            border-bottom: none;
        }

        .crew-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .crew-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .crew-table th {
            background: #f5f5f5;
            padding: 10px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #ddd;
        }

        .crew-table td {
            padding: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .crew-table input {
            width: 65px;
            border: none;
            text-align: center;
            padding: 4px;
            font-size: 12px;
        }

        .crew-role {
            text-align: left !important;
            font-weight: 500;
        }

        .summary-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .template-card {
            background: #f8f9ff;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .template-card:hover {
            border-color: #667eea;
            background: white;
        }

        .template-card h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .template-card p {
            font-size: 12px;
            color: #666;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            color: #1565C0;
        }

        .alert-success {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
            color: #2E7D32;
        }

        .discount-section {
            background: #fff3e0;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #FF9800;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 1400px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-selector {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° EPITOME COLLECTIVE</h1>
            <p>Professional Video Production Costing Calculator</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">Powered by intelligent pricing from 104+ real projects</p>
        </div>

        <div class="mode-selector">
            <div class="mode-card active" onclick="setMode('cost-up')">
                <h3>üìà Cost-Up Mode</h3>
                <p>Calculate from scratch when client doesn't give budget</p>
            </div>
            <div class="mode-card" onclick="setMode('budget-down')">
                <h3>üéØ Budget-Down Mode</h3>
                <p>Work backwards from client's given budget</p>
            </div>
        </div>

        <div class="calculator-grid">
            <!-- LEFT PANEL -->
            <div class="left-panel">
                <!-- Project Information -->
                <div class="section">
                    <h3>üìã Project Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Quote Number</label>
                            <input type="text" class="form-control" id="quoteNumber" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="text" class="form-control" id="quoteDate" readonly>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project Name *</label>
                            <input type="text" class="form-control" id="projectName" placeholder="Enter project name">
                        </div>
                        <div class="form-group">
                            <label>Client Name *</label>
                            <input type="text" class="form-control" id="clientName" placeholder="Enter client name">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" class="form-control" id="contactPerson" placeholder="Attention">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" class="form-control" id="phoneNumber" placeholder="Contact number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Client Email</label>
                        <input type="email" class="form-control" id="clientEmail" placeholder="client@company.com">
                    </div>
                    
                    <div class="form-group">
                        <label>Usage Rights</label>
                        <input type="text" class="form-control" id="usageRights" placeholder="e.g. Digital, Social, Singapore - 12 months">
                    </div>
                </div>

                <!-- Budget-Down Mode Section -->
                <div class="section hidden" id="budget-section">
                    <h3>üéØ Client Budget Analysis</h3>
                    <div class="alert alert-info">
                        <strong>Budget-Down Mode:</strong> Enter client's budget to see optimal cost allocation
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Client Budget (SGD) *</label>
                            <input type="number" class="form-control budget-highlight" id="clientBudget" placeholder="Enter total budget" onchange="calculateBudgetBreakdown()">
                        </div>
                        <div class="form-group">
                            <label>Target Margin %</label>
                            <input type="number" class="form-control" id="targetMargin" value="60" min="40" max="75" onchange="calculateBudgetBreakdown()">
                        </div>
                    </div>
                    
                    <div class="alert alert-success" id="budget-analysis" style="display: none;">
                        <!-- Budget breakdown will appear here -->
                    </div>
                </div>

                <!-- Production Costs -->
                <div class="section">
                    <h3>üí∞ Production Costs</h3>
                    <table class="cost-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">Category</th>
                                <th style="width: 25%;">Amount (SGD)</th>
                                <th style="width: 25%;">Budget Guide</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1. Pre-production Cost</td>
                                <td><input type="number" id="preproduction" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-preproduction" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>2. Production Unit</td>
                                <td><input type="number" id="production" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-production" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>3. Overtime</td>
                                <td><input type="number" id="overtime" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-overtime" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>4. Equipment</td>
                                <td><input type="number" id="equipment" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-equipment" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>5. Data Management</td>
                                <td><input type="number" id="datamanagement" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-datamanagement" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>6. Location and Studio Rental</td>
                                <td><input type="number" id="location" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-location" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>7. Props and settings</td>
                                <td><input type="number" id="props" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-props" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>8. Talents</td>
                                <td><input type="number" id="talents" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-talents" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>9. Wardrobes</td>
                                <td><input type="number" id="wardrobes" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-wardrobes" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>10. Catering</td>
                                <td><input type="number" id="catering" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-catering" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>11. Transportation</td>
                                <td><input type="number" id="transportation" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-transportation" class="text-muted">$0</span></td>
                            </tr>
                            <tr>
                                <td>12. Post production & music</td>
                                <td><input type="number" id="postproduction" value="0" onchange="calculateTotals()"></td>
                                <td><span id="guide-postproduction" class="text-muted">$0</span></td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Total Cost of Production</strong></td>
                                <td><strong><span id="totalCost">$0</span></strong></td>
                                <td><strong><span id="totalGuide">$0</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Project Templates -->
                <div class="section">
                    <h3>üé¨ Quick Start Templates</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Load cost structures from typical projects</p>
                    <div class="template-grid">
                        <div class="template-card" onclick="loadTemplate('social')">
                            <h4>Social Content</h4>
                            <p>$15K-$25K range</p>
                        </div>
                        <div class="template-card" onclick="loadTemplate('commercial')">
                            <h4>Commercial</h4>
                            <p>$50K-$80K range</p>
                        </div>
                        <div class="template-card" onclick="loadTemplate('tvc')">
                            <h4>TVC Campaign</h4>
                            <p>$150K+ range</p>
                        </div>
                        <div class="template-card" onclick="loadTemplate('corporate')">
                            <h4>Corporate</h4>
                            <p>$30K-$50K range</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MIDDLE PANEL -->
            <div class="middle-panel">
                <!-- Detailed Crew Breakdown -->
                <div class="section">
                    <h3>üë• Detailed Crew Breakdown</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Adjust crew rates, days, and roles based on project requirements</p>
                    
                    <div class="crew-section">
                        <table class="crew-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Role</th>
                                    <th style="width: 12%;">Prep</th>
                                    <th style="width: 12%;">Shoot</th>
                                    <th style="width: 12%;">Wrap</th>
                                    <th style="width: 15%;">Rate/Day</th>
                                    <th style="width: 14%;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="crewTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Variable Costs -->
                <div class="section">
                    <h3>üìä Variable Cost Analysis</h3>
                    <div class="summary-row">
                        <span>Crew Cost (from breakdown)</span>
                        <span id="crewTotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Equipment & Technical</span>
                        <span id="equipmentTotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Creative & Production</span>
                        <span id="creativeTotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Post-Production</span>
                        <span id="postTotal">$0</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <div class="right-panel">
                <!-- Discount Section -->
                <div class="discount-section">
                    <h3 style="color: #E65100; margin-bottom: 15px;">üí∞ Discount Management</h3>
                    
                    <div class="form-group">
                        <label>Discount Description</label>
                        <input type="text" class="form-control" id="discountDescription" placeholder="e.g. Retainer Discount, Repeat Client Discount, Sign by 10th May 2026 Discount">
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Discount %</label>
                            <input type="number" class="form-control" id="discountPercent" value="0" min="0" max="25" onchange="calculateTotals()">
                        </div>
                        <div class="form-group">
                            <label>Discount Amount</label>
                            <input type="number" class="form-control" id="discountAmount" readonly>
                        </div>
                    </div>
                </div>

                <!-- Quote Summary -->
                <div class="summary-panel">
                    <h3>üìã Quote Summary</h3>
                    <div class="summary-row">
                        <span>Total Production Cost</span>
                        <span id="summaryProductionCost">$0</span>
                    </div>
                    <div class="summary-row" id="discount-row" style="display: none;">
                        <span id="discountLabel">Discount</span>
                        <span id="summaryDiscountAmount">-$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Sub Total</span>
                        <span id="summarySubTotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>GST (9%)</span>
                        <span id="summaryGST">$0</span>
                    </div>
                    <div class="summary-row">
                        <span><strong>GRAND TOTAL</strong></span>
                        <span><strong id="summaryGrandTotal">$0</strong></span>
                    </div>
                </div>

                <!-- Margin Analysis -->
                <div class="summary-panel">
                    <h3>üìä Margin Analysis</h3>
                    <div class="summary-row">
                        <span>Production Cost</span>
                        <span id="marginCost">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Client Pays</span>
                        <span id="marginRevenue">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Gross Margin %</span>
                        <span id="marginPercentage">0%</span>
                    </div>
                    <div class="summary-row">
                        <span><strong>Profit Amount</strong></span>
                        <span><strong id="profitAmount">$0</strong></span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="section">
                    <h3>üöÄ Actions</h3>
                    <button class="btn" onclick="generateProfessionalQuotation()">üìÑ Generate Professional Quotation</button>
                    <button class="btn btn-secondary" onclick="saveProject()">üíæ Save Project</button>
                    <button class="btn btn-secondary" onclick="loadProject()">üìÅ Load Saved Project</button>
                    <button class="btn btn-secondary" onclick="resetCalculator()">üîÑ Reset Calculator</button>
                </div>

                <!-- Current Mode Info -->
                <div class="alert alert-info" id="mode-info">
                    <strong>Cost-Up Mode:</strong> Building quote from internal costs
                </div>
            </div>
        </div>
    </div>

    <script>
        // Epitome Professional Calculator - Rebuilt with Opus Intelligence
        let currentMode = 'cost-up';
        
        // Crew structure based on your real quotations
        const CREW_ROLES = [
            { role: "Director Package", prep: 1, shoot: 2, wrap: 0, rate: 3500 },
            { role: "Executive Producer / Producer", prep: 1, shoot: 2, wrap: 0, rate: 1000 },
            { role: "Line Producer", prep: 1, shoot: 2, wrap: 0, rate: 650 },
            { role: "1st Assistant Director", prep: 1, shoot: 2, wrap: 0, rate: 400 },
            { role: "Production Manager", prep: 1, shoot: 2, wrap: 0, rate: 350 },
            { role: "Production Assistant", prep: 1, shoot: 2, wrap: 0, rate: 300 },
            { role: "Director of Photography", prep: 1, shoot: 2, wrap: 0, rate: 1200 },
            { role: "1st Camera Assistant", prep: 0.5, shoot: 2, wrap: 0, rate: 550 },
            { role: "Gaffer", prep: 1, shoot: 2, wrap: 0, rate: 800 },
            { role: "Best Boy Grip", prep: 0.5, shoot: 2, wrap: 0, rate: 350 },
            { role: "Sound Recordist", prep: 0, shoot: 2, wrap: 0, rate: 650 },
            { role: "Art Director", prep: 2, shoot: 2, wrap: 0.5, rate: 750 },
            { role: "Props Master", prep: 2, shoot: 2, wrap: 1, rate: 450 },
            { role: "Hair & Make-up Artist", prep: 0.5, shoot: 2, wrap: 0, rate: 700 },
            { role: "Wardrobe Stylist", prep: 1, shoot: 2, wrap: 0, rate: 650 },
            { role: "Casting Director", prep: 3, shoot: 0, wrap: 0, rate: 650 }
        ];

        // Budget allocation percentages from your project analysis
        const BUDGET_ALLOCATIONS = {
            preproduction: 0.03,
            production: 0.35,
            overtime: 0.02,
            equipment: 0.15,
            datamanagement: 0.01,
            location: 0.08,
            props: 0.06,
            talents: 0.18,
            wardrobes: 0.03,
            catering: 0.03,
            transportation: 0.04,
            postproduction: 0.22
        };

        // Project templates based on your real data
        const PROJECT_TEMPLATES = {
            social: {
                name: "Social Content Template",
                totalBudget: 20000,
                costs: { preproduction: 1000, production: 8000, equipment: 2500, talents: 3000, postproduction: 4500, transportation: 800, catering: 500 }
            },
            commercial: {
                name: "Commercial Template", 
                totalBudget: 65000,
                costs: { preproduction: 2000, production: 25000, equipment: 8000, location: 5000, talents: 12000, props: 3000, wardrobes: 2000, catering: 1500, transportation: 2500, postproduction: 18000 }
            },
            tvc: {
                name: "TVC Campaign Template",
                totalBudget: 180000,
                costs: { preproduction: 8000, production: 65000, equipment: 25000, location: 15000, props: 12000, talents: 35000, wardrobes: 8000, catering: 4000, transportation: 6000, postproduction: 45000 }
            },
            corporate: {
                name: "Corporate Video Template",
                totalBudget: 40000,
                costs: { preproduction: 1500, production: 15000, equipment: 6000, location: 3000, talents: 8000, props: 1500, catering: 1000, transportation: 1500, postproduction: 12000 }
            }
        };

        // Initialize calculator
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalculator();
            populateCrewTable();
            calculateTotals();
            
            // Load demo after 2 seconds if first time
            setTimeout(() => {
                if (!localStorage.getItem('epitome_pro_used')) {
                    loadTemplate('commercial');
                    localStorage.setItem('epitome_pro_used', 'true');
                }
            }, 2000);
        });

        function initializeCalculator() {
            // Set quote details
            document.getElementById('quoteNumber').value = 'QUO-' + Date.now().toString().slice(-6);
            document.getElementById('quoteDate').value = new Date().toLocaleDateString('en-SG');
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update mode cards
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide budget section
            const budgetSection = document.getElementById('budget-section');
            const modeInfo = document.getElementById('mode-info');
            
            if (mode === 'budget-down') {
                budgetSection.classList.remove('hidden');
                modeInfo.innerHTML = '<strong>Budget-Down Mode:</strong> Working backwards from client budget to optimize allocation';
                modeInfo.className = 'alert alert-success';
            } else {
                budgetSection.classList.add('hidden');
                modeInfo.innerHTML = '<strong>Cost-Up Mode:</strong> Building quote from internal costs';
                modeInfo.className = 'alert alert-info';
            }
            
            calculateTotals();
        }

        function populateCrewTable() {
            const tbody = document.getElementById('crewTableBody');
            let html = '';
            
            CREW_ROLES.forEach((crew, index) => {
                html += `
                    <tr>
                        <td class="crew-role">${crew.role}</td>
                        <td><input type="number" step="0.5" value="${crew.prep}" id="prep-${index}" onchange="updateCrewTotal()"></td>
                        <td><input type="number" step="0.5" value="${crew.shoot}" id="shoot-${index}" onchange="updateCrewTotal()"></td>
                        <td><input type="number" step="0.5" value="${crew.wrap}" id="wrap-${index}" onchange="updateCrewTotal()"></td>
                        <td><input type="number" value="${crew.rate}" id="rate-${index}" onchange="updateCrewTotal()"></td>
                        <td><strong><span id="total-${index}">$${calculateCrewCost(crew)}</span></strong></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateCrewTotal();
        }

        function calculateCrewCost(crew) {
            return ((crew.prep + crew.shoot + crew.wrap) * crew.rate).toFixed(0);
        }

        function updateCrewTotal() {
            let totalCrewCost = 0;
            
            CREW_ROLES.forEach((crew, index) => {
                const prep = parseFloat(document.getElementById(`prep-${index}`).value) || 0;
                const shoot = parseFloat(document.getElementById(`shoot-${index}`).value) || 0;
                const wrap = parseFloat(document.getElementById(`wrap-${index}`).value) || 0;
                const rate = parseFloat(document.getElementById(`rate-${index}`).value) || 0;
                
                const total = (prep + shoot + wrap) * rate;
                document.getElementById(`total-${index}`).textContent = `$${total.toFixed(0)}`;
                totalCrewCost += total;
            });
            
            // Update production unit
            document.getElementById('production').value = Math.round(totalCrewCost);
            
            // Update variable costs display
            updateVariableCosts();
            calculateTotals();
        }

        function updateVariableCosts() {
            const crewCost = parseFloat(document.getElementById('production').value) || 0;
            const equipmentCost = parseFloat(document.getElementById('equipment').value) || 0;
            const dataCost = parseFloat(document.getElementById('datamanagement').value) || 0;
            
            const creativeCost = (parseFloat(document.getElementById('preproduction').value) || 0) + 
                                (parseFloat(document.getElementById('props').value) || 0) + 
                                (parseFloat(document.getElementById('talents').value) || 0) + 
                                (parseFloat(document.getElementById('wardrobes').value) || 0);
            
            const postCost = parseFloat(document.getElementById('postproduction').value) || 0;
            
            document.getElementById('crewTotal').textContent = `$${crewCost.toFixed(0)}`;
            document.getElementById('equipmentTotal').textContent = `$${(equipmentCost + dataCost).toFixed(0)}`;
            document.getElementById('creativeTotal').textContent = `$${creativeCost.toFixed(0)}`;
            document.getElementById('postTotal').textContent = `$${postCost.toFixed(0)}`;
        }

        function calculateBudgetBreakdown() {
            if (currentMode !== 'budget-down') return;
            
            const clientBudget = parseFloat(document.getElementById('clientBudget').value) || 0;
            const targetMargin = parseFloat(document.getElementById('targetMargin').value) || 60;
            
            if (clientBudget === 0) {
                document.getElementById('budget-analysis').style.display = 'none';
                return;
            }
            
            // Calculate available production budget
            const budgetAfterGST = clientBudget / 1.09;
            const availableForProduction = budgetAfterGST * (1 - targetMargin/100);
            
            // Show budget analysis
            const analysisDiv = document.getElementById('budget-analysis');
            analysisDiv.style.display = 'block';
            analysisDiv.innerHTML = `
                <h4>Budget Analysis:</h4>
                <p><strong>Client Budget:</strong> $${clientBudget.toLocaleString()}</p>
                <p><strong>After GST (9%):</strong> $${budgetAfterGST.toFixed(0).toLocaleString()}</p>
                <p><strong>Target Margin:</strong> ${targetMargin}%</p>
                <p><strong>Available for Production:</strong> $${availableForProduction.toFixed(0).toLocaleString()}</p>
            `;
            
            // Update budget guides for each category
            Object.keys(BUDGET_ALLOCATIONS).forEach(category => {
                const allocation = availableForProduction * BUDGET_ALLOCATIONS[category];
                document.getElementById(`guide-${category}`).textContent = `$${Math.round(allocation)}`;
                
                // Auto-fill if field is empty or in budget-down mode
                if (document.getElementById(category).value == 0 || currentMode === 'budget-down') {
                    document.getElementById(category).value = Math.round(allocation);
                }
            });
            
            document.getElementById('totalGuide').textContent = `$${Math.round(availableForProduction)}`;
            calculateTotals();
        }

        function calculateTotals() {
            // Get all cost values
            const categories = ['preproduction', 'production', 'overtime', 'equipment', 
                             'datamanagement', 'location', 'props', 'talents', 'wardrobes', 
                             'catering', 'transportation', 'postproduction'];
            
            let totalProductionCost = 0;
            categories.forEach(category => {
                const value = parseFloat(document.getElementById(category).value) || 0;
                totalProductionCost += value;
            });
            
            // Apply discount
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = totalProductionCost * (discountPercent / 100);
            const subTotal = totalProductionCost - discountAmount;
            
            // Calculate GST
            const gst = subTotal * 0.09;
            const grandTotal = subTotal + gst;
            
            // Update all displays
            document.getElementById('totalCost').textContent = `$${totalProductionCost.toFixed(0)}`;
            document.getElementById('discountAmount').value = discountAmount.toFixed(0);
            
            // Update summary panel
            document.getElementById('summaryProductionCost').textContent = `$${totalProductionCost.toFixed(0)}`;
            document.getElementById('summaryDiscountAmount').textContent = `-$${discountAmount.toFixed(0)}`;
            document.getElementById('summarySubTotal').textContent = `$${subTotal.toFixed(0)}`;
            document.getElementById('summaryGST').textContent = `$${gst.toFixed(0)}`;
            document.getElementById('summaryGrandTotal').textContent = `$${grandTotal.toFixed(0)}`;
            
            // Show/hide discount row and update label
            const discountRow = document.getElementById('discount-row');
            const discountLabel = document.getElementById('discountLabel');
            const discountDesc = document.getElementById('discountDescription').value;
            
            if (discountPercent > 0) {
                discountRow.style.display = 'flex';
                discountLabel.textContent = discountDesc || `Discount (${discountPercent}%)`;
            } else {
                discountRow.style.display = 'none';
            }
            
            // Update margin analysis
            const profit = grandTotal - totalProductionCost;
            const marginPercentage = totalProductionCost > 0 ? ((profit / grandTotal) * 100) : 0;
            
            document.getElementById('marginCost').textContent = `$${totalProductionCost.toFixed(0)}`;
            document.getElementById('marginRevenue').textContent = `$${grandTotal.toFixed(0)}`;
            document.getElementById('marginPercentage').textContent = `${marginPercentage.toFixed(1)}%`;
            document.getElementById('profitAmount').textContent = `$${profit.toFixed(0)}`;
            
            // Update variable costs
            updateVariableCosts();
        }

        function loadTemplate(templateType) {
            const template = PROJECT_TEMPLATES[templateType];
            if (!template) return;
            
            // Load template data
            document.getElementById('projectName').value = template.name;
            document.getElementById('clientName').value = 'Sample Client Ltd';
            
            // Load costs
            Object.keys(template.costs).forEach(category => {
                const input = document.getElementById(category);
                if (input) {
                    input.value = template.costs[category];
                }
            });
            
            // Recalculate crew based on production cost
            const productionCost = template.costs.production || 0;
            if (productionCost > 0) {
                // Distribute production cost across crew roles proportionally
                const totalDefaultCost = CREW_ROLES.reduce((sum, crew) => sum + ((crew.prep + crew.shoot + crew.wrap) * crew.rate), 0);
                const scaleFactor = productionCost / totalDefaultCost;
                
                CREW_ROLES.forEach((crew, index) => {
                    const scaledRate = Math.round(crew.rate * scaleFactor);
                    document.getElementById(`rate-${index}`).value = scaledRate;
                });
            }
            
            updateCrewTotal();
            calculateTotals();
            
            alert(`${template.name} loaded successfully! Adjust values as needed for your specific project.`);
        }

        function generateProfessionalQuotation() {
            const projectName = document.getElementById('projectName').value;
            const clientName = document.getElementById('clientName').value;
            
            if (!projectName || !clientName) {
                alert('Please enter project name and client name before generating quotation.');
                return;
            }
            
            // Generate PDF with your exact format
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header exactly like your quotations
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('QUOTATION', 20, 25);
            
            // Add page number and project info
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Page 1 of 2', 160, 25);
            
            // Project details section
            let yPos = 45;
            doc.text(`QUO Number : ${document.getElementById('quoteNumber').value}`, 20, yPos);
            yPos += 10;
            doc.text(`Job Description : ${projectName}`, 20, yPos);
            yPos += 10;
            doc.text(`Client : ${clientName}`, 20, yPos);
            yPos += 10;
            doc.text(`Attention: ${document.getElementById('contactPerson').value}`, 20, yPos);
            yPos += 10;
            doc.text(`Contact : ${document.getElementById('phoneNumber').value}`, 20, yPos);
            yPos += 10;
            doc.text(`Email : ${document.getElementById('clientEmail').value}`, 20, yPos);
            
            yPos += 20;
            doc.text('Based on 1 week standby for support crew', 20, yPos);
            yPos += 10;
            doc.text('Based on SGD currency and all terms and conditions on quote.', 20, yPos);
            
            yPos += 20;
            doc.setFont(undefined, 'bold');
            doc.text('SUMMARY OF PRODUCTION COSTS:', 20, yPos);
            doc.text('Remarks', 170, yPos);
            
            // Cost breakdown
            yPos += 20;
            doc.setFont(undefined, 'normal');
            
            const categories = [
                ['1. Pre-production Cost', 'preproduction'],
                ['2. Production Unit', 'production'],
                ['3. Overtime', 'overtime'],
                ['4. Equipment', 'equipment'],
                ['5. Data Management', 'datamanagement'],
                ['6. Location and Studio Rental', 'location'],
                ['7. Props and settings', 'props'],
                ['8. Talents', 'talents'],
                ['9. Wardrobes', 'wardrobes'],
                ['10. Catering', 'catering'],
                ['11. Transportation', 'transportation'],
                ['12. Post production & music production', 'postproduction']
            ];
            
            categories.forEach(([label, id]) => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                doc.text(`${label}  -  $`, 20, yPos);
                doc.text(`${value.toLocaleString('en-SG')}.00`, 75, yPos);
                doc.text('$', 170, yPos);
                yPos += 12;
            });
            
            // Totals section
            yPos += 10;
            const totalCost = categories.reduce((sum, [, id]) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = totalCost * (discountPercent / 100);
            const subTotal = totalCost - discountAmount;
            const gst = subTotal * 0.09;
            const grandTotal = subTotal + gst;
            
            doc.text(`Total Cost of Production`, 20, yPos);
            doc.text(`${totalCost.toLocaleString('en-SG')}.00 $`, 130, yPos);
            yPos += 12;
            
            if (discountPercent > 0) {
                const discountDesc = document.getElementById('discountDescription').value || 'Discount';
                doc.text(discountDesc, 20, yPos);
                doc.text(`${discountPercent}%`, 100, yPos);
                doc.text(`${discountAmount.toLocaleString('en-SG')}.00 -$`, 130, yPos);
                yPos += 12;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('SUB TOTAL', 20, yPos);
            doc.text(`${subTotal.toLocaleString('en-SG')}.00 $`, 130, yPos);
            yPos += 12;
            
            doc.text('GST 9%', 20, yPos);
            doc.text(`${gst.toLocaleString('en-SG')}.00 $`, 130, yPos);
            yPos += 12;
            
            doc.text('GRAND TOTAL', 20, yPos);
            doc.text(`${grandTotal.toLocaleString('en-SG')}.00 $`, 130, yPos);
            
            yPos += 25;
            doc.setFont(undefined, 'normal');
            doc.text('Approved by:', 20, yPos);
            doc.text('Date :', 20, yPos + 15);
            doc.text('Conditions of Agreement: * see overleaf for terms of payment', 20, yPos + 30);
            doc.text(`Usage: ${document.getElementById('usageRights').value}`, 20, yPos + 45);
            
            // Add second page with T&Cs
            doc.addPage();
            addTermsAndConditions(doc);
            
            // Save the PDF
            const fileName = `${projectName.replace(/\s+/g, '_')}_Quotation_${document.getElementById('quoteNumber').value}.pdf`;
            doc.save(fileName);
            
            alert('Professional quotation generated successfully!');
        }

        function addTermsAndConditions(doc) {
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('TERMS AND CONDITIONS:', 20, 25);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const terms = [
                '1. This quotation is valid for 30 days from the date hereof.',
                '',
                '2. Both parties agree that your acceptance of this quotation shall constitute a formal and binding',
                'contract ("Contract"), subject to the terms and conditions below, for the purchase of the above',
                'mentioned items (the "Items") from us and that the date of acceptance from you, shall be the date',
                'of the said contract (the "Date of the Contract").',
                '',
                '3. Fees and expenses quoted are for the original job description and layouts only, and for the',
                'usage specified.',
                '',
                'First Payment - 50% upon job confirmation and no later than 14 working days before first camera roll.',
                'Second Payment - 30% upon first draft',
                'Final Payment - 20% payment 30 days upon completion of job.',
                '',
                'Job cancellation prior to principal photography will incur costs. Rates are the following:',
                '3 weeks (21 Days) before shoot commencement = 100% of Pre-Production Fees + 25% of Total Production Fees',
                '7 Days = 100% of Pre-Production Fees + 100% of Total Production Fees, plus all incurring expenses.',
                '',
                '4. This quotation excludes contingency shoot days. This is any day where a scheduled shooting has been',
                'prevented from occurring due to circumstances beyond the control of the production company.',
                '',
                '5. Overtime fees are as the following: [Normal crew rate/10 x (number of hours OT) x 2]. If the shoot',
                'crosses midnight, transportation fees also are applicable.',
                '',
                '6. Media Usage describes and restricts where and how long the video can be seen. Should the agency',
                'or client use the video outside the terms indicated at the top of this quotation, the production',
                'company will not be liable for any of the consequential legal or other costs or charges incurred.',
                '',
                '7. All prices quoted are in Singapore Dollars unless otherwise stated.',
                '',
                '8. Epitome Productions Pte Ltd will possess all ownership rights to footage and works created by us,',
                'unless otherwise stated.',
                '',
                'TERMS OF PAYMENT:',
                '- First 50% upon job confirmation and no later that 14 working days before first camera roll',
                '- Second Payment - 30% payment upon first draft',
                '- Final Payment - 20% payment upon completion',
                '',
                'For bank transfer, please use the following details:',
                'Company Name: Epitome Productions Pte Ltd',
                'Bank Name : DBS Bank',
                'Account Number: 0179051975',
                'Swift Code: DBSSSGSG'
            ];
            
            let yPos = 45;
            terms.forEach(term => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 25;
                }
                doc.text(term, 20, yPos);
                yPos += 12;
            });
        }

        function saveProject() {
            const projectName = document.getElementById('projectName').value;
            if (!projectName) {
                alert('Please enter a project name before saving.');
                return;
            }
            
            // Gather all project data
            const projectData = {
                basic: {
                    name: projectName,
                    client: document.getElementById('clientName').value,
                    contact: document.getElementById('contactPerson').value,
                    phone: document.getElementById('phoneNumber').value,
                    email: document.getElementById('clientEmail').value,
                    usage: document.getElementById('usageRights').value
                },
                costs: {},
                crew: [],
                discount: {
                    description: document.getElementById('discountDescription').value,
                    percent: document.getElementById('discountPercent').value
                },
                mode: currentMode,
                savedAt: new Date().toISOString()
            };
            
            // Save costs
            const categories = ['preproduction', 'production', 'overtime', 'equipment', 
                             'datamanagement', 'location', 'props', 'talents', 'wardrobes', 
                             'catering', 'transportation', 'postproduction'];
            
            categories.forEach(category => {
                projectData.costs[category] = document.getElementById(category).value;
            });
            
            // Save crew data
            CREW_ROLES.forEach((crew, index) => {
                projectData.crew.push({
                    role: crew.role,
                    prep: document.getElementById(`prep-${index}`).value,
                    shoot: document.getElementById(`shoot-${index}`).value,
                    wrap: document.getElementById(`wrap-${index}`).value,
                    rate: document.getElementById(`rate-${index}`).value
                });
            });
            
            // Save to localStorage
            localStorage.setItem(`epitome_pro_${projectName}`, JSON.stringify(projectData));
            alert(`Project '${projectName}' saved successfully!`);
        }

        function loadProject() {
            // Get list of saved projects
            const projects = [];
            for (let key in localStorage) {
                if (key.startsWith('epitome_pro_')) {
                    projects.push(key.replace('epitome_pro_', ''));
                }
            }
            
            if (projects.length === 0) {
                alert('No saved projects found.');
                return;
            }
            
            const projectName = prompt(`Select project to load:\\n\\n${projects.join('\\n')}\\n\\nEnter project name:`);
            if (projectName && projects.includes(projectName)) {
                const projectData = JSON.parse(localStorage.getItem(`epitome_pro_${projectName}`));
                loadProjectData(projectData);
                alert(`Project '${projectName}' loaded successfully!`);
            }
        }

        function loadProjectData(data) {
            // Load basic info
            if (data.basic) {
                document.getElementById('projectName').value = data.basic.name || '';
                document.getElementById('clientName').value = data.basic.client || '';
                document.getElementById('contactPerson').value = data.basic.contact || '';
                document.getElementById('phoneNumber').value = data.basic.phone || '';
                document.getElementById('clientEmail').value = data.basic.email || '';
                document.getElementById('usageRights').value = data.basic.usage || '';
            }
            
            // Load costs
            if (data.costs) {
                Object.entries(data.costs).forEach(([key, value]) => {
                    const input = document.getElementById(key);
                    if (input) input.value = value;
                });
            }
            
            // Load crew
            if (data.crew && data.crew.length === CREW_ROLES.length) {
                data.crew.forEach((crewData, index) => {
                    document.getElementById(`prep-${index}`).value = crewData.prep;
                    document.getElementById(`shoot-${index}`).value = crewData.shoot;
                    document.getElementById(`wrap-${index}`).value = crewData.wrap;
                    document.getElementById(`rate-${index}`).value = crewData.rate;
                });
            }
            
            // Load discount
            if (data.discount) {
                document.getElementById('discountDescription').value = data.discount.description || '';
                document.getElementById('discountPercent').value = data.discount.percent || '0';
            }
            
            // Set mode
            if (data.mode) {
                setMode(data.mode);
            }
            
            updateCrewTotal();
            calculateTotals();
        }

        function resetCalculator() {
            if (confirm('Are you sure you want to reset the calculator? All unsaved data will be lost.')) {
                // Reset all form fields
                document.getElementById('projectName').value = '';
                document.getElementById('clientName').value = '';
                document.getElementById('contactPerson').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('usageRights').value = '';
                document.getElementById('discountDescription').value = '';
                document.getElementById('discountPercent').value = '0';
                document.getElementById('clientBudget').value = '';
                document.getElementById('targetMargin').value = '60';
                
                // Reset all cost inputs
                const categories = ['preproduction', 'production', 'overtime', 'equipment', 
                                 'datamanagement', 'location', 'props', 'talents', 'wardrobes', 
                                 'catering', 'transportation', 'postproduction'];
                
                categories.forEach(category => {
                    document.getElementById(category).value = '0';
                });
                
                // Reset crew to defaults
                populateCrewTable();
                
                // Generate new quote number
                document.getElementById('quoteNumber').value = 'QUO-' + Date.now().toString().slice(-6);
                
                calculateTotals();
                alert('Calculator reset successfully!');
            }
        }
    </script>
</body>
</html>