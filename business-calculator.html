<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epitome Collective - Business Costing Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #333;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .mode-selector {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .left-panel, .right-panel {
            padding: 20px;
        }

        .right-panel {
            background: #f8f9fa;
            border-left: 1px solid #ddd;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .cost-table {
            width: 100%;
            min-width: 500px;
            border-collapse: collapse;
        }

        .cost-table th,
        .cost-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .cost-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .cost-table input {
            width: 100%;
            border: none;
            padding: 4px;
            text-align: right;
        }

        .cost-table input:focus {
            outline: 1px solid #667eea;
        }

        .crew-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            font-size: 12px;
        }

        .crew-table th,
        .crew-table td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: center;
        }

        .crew-table th {
            background: #f5f5f5;
            font-weight: bold;
            font-size: 11px;
        }

        .crew-table input {
            width: 60px;
            border: none;
            padding: 2px;
            text-align: center;
        }

        .total-row {
            background: #667eea !important;
            color: white;
            font-weight: bold;
        }

        .summary-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 16px;
            color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .discount-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .loading-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .budget-input {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert-info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 1200px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .discount-section {
                grid-template-columns: 1fr;
            }
            
            .loading-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 0;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .mode-selector {
                padding: 10px;
            }
            
            .mode-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .mode-btn {
                padding: 15px 20px;
                font-size: 16px;
            }
            
            .left-panel, .right-panel {
                padding: 15px;
            }
            
            .cost-table, .crew-table {
                font-size: 12px;
            }
            
            .cost-table th,
            .cost-table td,
            .crew-table th,
            .crew-table td {
                padding: 6px 8px;
            }
            
            .cost-table input,
            .crew-table input {
                font-size: 12px;
                padding: 2px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .cost-table, .crew-table {
                font-size: 11px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .cost-table input {
                width: 80px;
            }
            
            .crew-table input {
                width: 50px;
            }
            
            .section h3 {
                font-size: 16px;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EPITOME COLLECTIVE</h1>
            <p>Business Costing Calculator</p>
        </div>

        <div class="mode-selector">
            <p><strong>Select Your Costing Approach:</strong></p>
            <div class="mode-buttons">
                <button class="mode-btn active" onclick="setMode('cost-up')">
                    üìà COST-UP: Calculate from scratch
                </button>
                <button class="mode-btn" onclick="setMode('budget-down')">
                    üéØ BUDGET-DOWN: Work from client budget
                </button>
            </div>
        </div>

        <div class="calculator-grid">
            <!-- LEFT PANEL -->
            <div class="left-panel">
                <!-- Project Details -->
                <div class="section">
                    <h3>Project Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quote Number</label>
                            <input type="text" class="form-control" id="quoteNumber" value="" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="text" class="form-control" id="quoteDate" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project Name *</label>
                            <input type="text" class="form-control" id="projectName" placeholder="Enter project name">
                        </div>
                        <div class="form-group">
                            <label>Client *</label>
                            <input type="text" class="form-control" id="clientName" placeholder="Enter client name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Attention</label>
                            <input type="text" class="form-control" id="clientContact" placeholder="Contact person">
                        </div>
                        <div class="form-group">
                            <label>Contact</label>
                            <input type="text" class="form-control" id="clientPhone" placeholder="Phone number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Usage Rights</label>
                        <input type="text" class="form-control" id="usageRights" placeholder="e.g. Digital, Social, Singapore - 12 months">
                    </div>
                </div>

                <!-- Budget Input (Budget-Down Mode) -->
                <div class="section hidden" id="budget-section">
                    <h3>Client Budget</h3>
                    <div class="alert alert-info">
                        <strong>Budget-Down Mode:</strong> Enter the client's budget and we'll calculate what you can afford for each category.
                    </div>
                    <div class="form-group">
                        <label>Client Budget (SGD) *</label>
                        <input type="number" class="form-control budget-input" id="clientBudget" placeholder="Enter client budget" onchange="calculateBudgetBreakdown()">
                    </div>
                    <div class="form-group">
                        <label>Target Margin %</label>
                        <input type="number" class="form-control" id="targetMargin" value="60" min="40" max="75" onchange="calculateBudgetBreakdown()">
                    </div>
                </div>

                <!-- 12 Cost Categories -->
                <div class="section">
                    <h3>Production Costs</h3>
                    <div class="table-container">
                        <table class="cost-table">
                        <thead>
                            <tr>
                                <th width="50%">Category</th>
                                <th width="25%">Amount (SGD)</th>
                                <th width="25%">Budget Allocation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>1. Pre-production Cost</td><td><input type="number" id="preproduction" value="0" onchange="calculateTotals()"></td><td><span id="alloc-preproduction">$0</span></td></tr>
                            <tr><td>2. Production Unit</td><td><input type="number" id="production" value="0" onchange="calculateTotals()"></td><td><span id="alloc-production">$0</span></td></tr>
                            <tr><td>3. Overtime</td><td><input type="number" id="overtime" value="0" onchange="calculateTotals()"></td><td><span id="alloc-overtime">$0</span></td></tr>
                            <tr><td>4. Equipment</td><td><input type="number" id="equipment" value="0" onchange="calculateTotals()"></td><td><span id="alloc-equipment">$0</span></td></tr>
                            <tr><td>5. Data Management</td><td><input type="number" id="datamanagement" value="0" onchange="calculateTotals()"></td><td><span id="alloc-datamanagement">$0</span></td></tr>
                            <tr><td>6. Location and Studio Rental</td><td><input type="number" id="location" value="0" onchange="calculateTotals()"></td><td><span id="alloc-location">$0</span></td></tr>
                            <tr><td>7. Props and settings</td><td><input type="number" id="props" value="0" onchange="calculateTotals()"></td><td><span id="alloc-props">$0</span></td></tr>
                            <tr><td>8. Talents</td><td><input type="number" id="talents" value="0" onchange="calculateTotals()"></td><td><span id="alloc-talents">$0</span></td></tr>
                            <tr><td>9. Wardrobes</td><td><input type="number" id="wardrobes" value="0" onchange="calculateTotals()"></td><td><span id="alloc-wardrobes">$0</span></td></tr>
                            <tr><td>10. Catering</td><td><input type="number" id="catering" value="0" onchange="calculateTotals()"></td><td><span id="alloc-catering">$0</span></td></tr>
                            <tr><td>11. Transportation</td><td><input type="number" id="transportation" value="0" onchange="calculateTotals()"></td><td><span id="alloc-transportation">$0</span></td></tr>
                            <tr><td>12. Post production & music</td><td><input type="number" id="postproduction" value="0" onchange="calculateTotals()"></td><td><span id="alloc-postproduction">$0</span></td></tr>
                            <tr class="total-row">
                                <td><strong>Total Cost of Production</strong></td>
                                <td><strong><span id="totalCost">$0</span></strong></td>
                                <td><strong><span id="totalAllocation">$0</span></strong></td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <div class="right-panel">
                <!-- Detailed Crew Breakdown -->
                <div class="section">
                    <h3>Detailed Crew Breakdown</h3>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        Based on your quotation structure. Adjust rates and days as needed.
                    </p>
                    <div class="table-container">
                        <table class="crew-table" id="crewTable">
                            <!-- Populated by JavaScript -->
                        </table>
                    </div>
                </div>

                <!-- Discounts & Loading -->
                <div class="section">
                    <h3>Discounts & Loading</h3>
                    <div class="discount-section">
                        <div class="form-group">
                            <label>Discount %</label>
                            <input type="number" class="form-control" id="discountPercent" value="0" min="0" max="20" onchange="calculateTotals()">
                        </div>
                        <div class="form-group">
                            <label>Discount Amount</label>
                            <input type="number" class="form-control" id="discountAmount" readonly>
                        </div>
                        <div class="form-group">
                            <label>Sub Total</label>
                            <input type="number" class="form-control" id="subTotal" readonly>
                        </div>
                    </div>
                    <div class="loading-section">
                        <div class="form-group">
                            <label>Usage Loading %</label>
                            <input type="number" class="form-control" id="usageLoading" value="0" min="0" max="50" onchange="calculateTotals()">
                        </div>
                        <div class="form-group">
                            <label>Geographic Loading %</label>
                            <input type="number" class="form-control" id="geoLoading" value="0" min="0" max="30" onchange="calculateTotals()">
                        </div>
                    </div>
                </div>

                <!-- Final Calculations -->
                <div class="summary-section">
                    <h3>Quote Summary</h3>
                    <div class="summary-row">
                        <span>Total Production Cost</span>
                        <span id="finalProductionCost">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Discount (<span id="finalDiscountPercent">0</span>%)</span>
                        <span id="finalDiscountAmount">-$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Sub Total</span>
                        <span id="finalSubTotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>GST (9%)</span>
                        <span id="gstAmount">$0</span>
                    </div>
                    <div class="summary-row">
                        <span><strong>GRAND TOTAL</strong></span>
                        <span><strong id="grandTotal">$0</strong></span>
                    </div>
                </div>

                <!-- Margin Analysis -->
                <div class="summary-section">
                    <h3>Margin Analysis</h3>
                    <div class="summary-row">
                        <span>Production Cost</span>
                        <span id="marginAnalysisCost">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Quote to Client</span>
                        <span id="marginAnalysisQuote">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Gross Margin %</span>
                        <span id="marginPercentage">0%</span>
                    </div>
                    <div class="summary-row">
                        <span><strong>Profit Amount</strong></span>
                        <span><strong id="profitAmount">$0</strong></span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="section">
                    <button class="btn" onclick="generateFullQuotation()">üìÑ Generate Full Quotation PDF</button>
                    <button class="btn btn-secondary" onclick="saveProject()">üíæ Save Project</button>
                    <button class="btn btn-secondary" onclick="loadProject()">üìÅ Load Project</button>
                    <button class="btn btn-secondary" onclick="loadSample()">üé¨ Load Sample Project</button>
                </div>

                <!-- Mode Info -->
                <div class="section" id="mode-info">
                    <div class="alert alert-info">
                        <strong>Cost-Up Mode:</strong> Calculate internal costs first, then determine your quote price.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Epitome Business Calculator - Rebuilt for Real Business Use
        // By Jax - Your AI Operations Partner

        let currentMode = 'cost-up';
        
        // Standard crew structure from your quotations
        const CREW_STRUCTURE = [
            { role: "Director Package", prep: 1, shoot: 2, wrap: 0, rate: 3500 },
            { role: "Executive Producer / Producer", prep: 1, shoot: 2, wrap: 0, rate: 1000 },
            { role: "Line Producer", prep: 1, shoot: 2, wrap: 0, rate: 650 },
            { role: "1st Assistant Director", prep: 1, shoot: 2, wrap: 0, rate: 400 },
            { role: "Production Manager", prep: 1, shoot: 2, wrap: 0, rate: 350 },
            { role: "Production Assistant", prep: 1, shoot: 2, wrap: 0, rate: 300 },
            { role: "Director of Photography", prep: 1, shoot: 2, wrap: 0, rate: 1200 },
            { role: "1st Camera Assistant", prep: 0.5, shoot: 2, wrap: 0, rate: 550 },
            { role: "Gaffer", prep: 1, shoot: 2, wrap: 0, rate: 800 },
            { role: "Best Boy Grip", prep: 0.5, shoot: 2, wrap: 0, rate: 350 },
            { role: "Sound Recordist", prep: 0, shoot: 2, wrap: 0, rate: 650 },
            { role: "Art Director", prep: 2, shoot: 2, wrap: 0.5, rate: 750 },
            { role: "Props Master", prep: 2, shoot: 2, wrap: 1, rate: 450 },
            { role: "Hair & Make-up Artist", prep: 0.5, shoot: 2, wrap: 0, rate: 700 },
            { role: "Wardrobe Stylist", prep: 1, shoot: 2, wrap: 0, rate: 650 },
            { role: "Casting Director", prep: 3, shoot: 0, wrap: 0, rate: 650 }
        ];

        // Budget allocation percentages (based on your real projects)
        const BUDGET_ALLOCATIONS = {
            preproduction: 0.03,
            production: 0.40,
            overtime: 0.02,
            equipment: 0.12,
            datamanagement: 0.01,
            location: 0.08,
            props: 0.05,
            talents: 0.15,
            wardrobes: 0.03,
            catering: 0.03,
            transportation: 0.05,
            postproduction: 0.23
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalculator();
            populateCrewTable();
            calculateTotals();
            
            // Auto-load sample after 2 seconds
            setTimeout(() => {
                if (!localStorage.getItem('epitome_business_used')) {
                    loadSample();
                    localStorage.setItem('epitome_business_used', 'true');
                }
            }, 2000);
        });

        function initializeCalculator() {
            // Set quote number and date
            document.getElementById('quoteNumber').value = 'QUO-' + Date.now().toString().slice(-6);
            document.getElementById('quoteDate').value = new Date().toLocaleDateString('en-SG');
            
            // Set initial mode
            setMode('cost-up');
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setMode('${mode}')"]`).classList.add('active');
            
            // Show/hide sections
            const budgetSection = document.getElementById('budget-section');
            const modeInfo = document.getElementById('mode-info');
            
            if (mode === 'budget-down') {
                budgetSection.classList.remove('hidden');
                modeInfo.innerHTML = '<div class="alert alert-warning"><strong>Budget-Down Mode:</strong> Enter client budget to see what you can afford for each category.</div>';
            } else {
                budgetSection.classList.add('hidden');
                modeInfo.innerHTML = '<div class="alert alert-info"><strong>Cost-Up Mode:</strong> Calculate internal costs first, then determine your quote price.</div>';
            }
            
            calculateTotals();
        }

        function populateCrewTable() {
            const table = document.getElementById('crewTable');
            let html = `
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Prep</th>
                        <th>Shoot</th>
                        <th>Wrap</th>
                        <th>Rate/Day</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            CREW_STRUCTURE.forEach((crew, index) => {
                html += `
                    <tr>
                        <td style="text-align: left;">${crew.role}</td>
                        <td><input type="number" step="0.5" value="${crew.prep}" onchange="updateCrewCost(${index})" id="prep-${index}"></td>
                        <td><input type="number" step="0.5" value="${crew.shoot}" onchange="updateCrewCost(${index})" id="shoot-${index}"></td>
                        <td><input type="number" step="0.5" value="${crew.wrap}" onchange="updateCrewCost(${index})" id="wrap-${index}"></td>
                        <td><input type="number" value="${crew.rate}" onchange="updateCrewCost(${index})" id="rate-${index}"></td>
                        <td><span id="total-${index}">$${calculateCrewCost(crew)}</span></td>
                    </tr>
                `;
            });
            
            html += `</tbody>`;
            table.innerHTML = html;
            
            updateProductionTotal();
        }

        function calculateCrewCost(crew) {
            const totalDays = crew.prep + crew.shoot + crew.wrap;
            return (totalDays * crew.rate).toFixed(0);
        }

        function updateCrewCost(index) {
            const prep = parseFloat(document.getElementById(`prep-${index}`).value) || 0;
            const shoot = parseFloat(document.getElementById(`shoot-${index}`).value) || 0;
            const wrap = parseFloat(document.getElementById(`wrap-${index}`).value) || 0;
            const rate = parseFloat(document.getElementById(`rate-${index}`).value) || 0;
            
            const total = (prep + shoot + wrap) * rate;
            document.getElementById(`total-${index}`).textContent = `$${total.toFixed(0)}`;
            
            updateProductionTotal();
        }

        function updateProductionTotal() {
            let productionTotal = 0;
            
            CREW_STRUCTURE.forEach((crew, index) => {
                const prep = parseFloat(document.getElementById(`prep-${index}`).value) || 0;
                const shoot = parseFloat(document.getElementById(`shoot-${index}`).value) || 0;
                const wrap = parseFloat(document.getElementById(`wrap-${index}`).value) || 0;
                const rate = parseFloat(document.getElementById(`rate-${index}`).value) || 0;
                
                productionTotal += (prep + shoot + wrap) * rate;
            });
            
            // Update the production unit input
            document.getElementById('production').value = Math.round(productionTotal);
            calculateTotals();
        }

        function calculateBudgetBreakdown() {
            if (currentMode !== 'budget-down') return;
            
            const clientBudget = parseFloat(document.getElementById('clientBudget').value) || 0;
            const targetMargin = parseFloat(document.getElementById('targetMargin').value) || 60;
            
            if (clientBudget === 0) return;
            
            // Calculate available production budget after GST and margin
            const budgetBeforeGST = clientBudget / 1.09;
            const availableForProduction = budgetBeforeGST * (1 - targetMargin/100);
            
            // Allocate to each category
            Object.keys(BUDGET_ALLOCATIONS).forEach(category => {
                const allocation = availableForProduction * BUDGET_ALLOCATIONS[category];
                document.getElementById(`alloc-${category}`).textContent = `$${Math.round(allocation)}`;
                
                // Suggest this as the cost
                if (document.getElementById(category).value == 0) {
                    document.getElementById(category).value = Math.round(allocation);
                }
            });
            
            document.getElementById('totalAllocation').textContent = `$${Math.round(availableForProduction)}`;
            calculateTotals();
        }

        function calculateTotals() {
            // Get all cost values
            const categories = ['preproduction', 'production', 'overtime', 'equipment', 
                             'datamanagement', 'location', 'props', 'talents', 'wardrobes', 
                             'catering', 'transportation', 'postproduction'];
            
            let totalCost = 0;
            categories.forEach(category => {
                const value = parseFloat(document.getElementById(category).value) || 0;
                totalCost += value;
            });
            
            // Apply discount
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = totalCost * (discountPercent / 100);
            const subTotal = totalCost - discountAmount;
            
            // Apply loading
            const usageLoading = parseFloat(document.getElementById('usageLoading').value) || 0;
            const geoLoading = parseFloat(document.getElementById('geoLoading').value) || 0;
            const totalLoading = (usageLoading + geoLoading) / 100;
            const loadedSubTotal = subTotal * (1 + totalLoading);
            
            // Calculate GST
            const gst = loadedSubTotal * 0.09;
            const grandTotal = loadedSubTotal + gst;
            
            // Update displays
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(0)}`;
            document.getElementById('discountAmount').value = discountAmount.toFixed(0);
            document.getElementById('subTotal').value = subTotal.toFixed(0);
            
            document.getElementById('finalProductionCost').textContent = `$${totalCost.toFixed(0)}`;
            document.getElementById('finalDiscountPercent').textContent = discountPercent;
            document.getElementById('finalDiscountAmount').textContent = `-$${discountAmount.toFixed(0)}`;
            document.getElementById('finalSubTotal').textContent = `$${loadedSubTotal.toFixed(0)}`;
            document.getElementById('gstAmount').textContent = `$${gst.toFixed(0)}`;
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(0)}`;
            
            // Margin analysis
            const marginAmount = grandTotal - totalCost;
            const marginPercent = totalCost > 0 ? ((marginAmount / grandTotal) * 100) : 0;
            
            document.getElementById('marginAnalysisCost').textContent = `$${totalCost.toFixed(0)}`;
            document.getElementById('marginAnalysisQuote').textContent = `$${grandTotal.toFixed(0)}`;
            document.getElementById('marginPercentage').textContent = `${marginPercent.toFixed(1)}%`;
            document.getElementById('profitAmount').textContent = `$${marginAmount.toFixed(0)}`;
        }

        function generateFullQuotation() {
            const projectName = document.getElementById('projectName').value;
            const clientName = document.getElementById('clientName').value;
            
            if (!projectName || !clientName) {
                alert('Please enter project name and client name before generating quotation.');
                return;
            }
            
            // Calculate all values
            calculateTotals();
            
            // Generate PDF with exact format from your quotations
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header - exactly like your quotations
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('QUOTATION', 20, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`QUO Number : ${document.getElementById('quoteNumber').value}`, 20, 40);
            doc.text(`Job Description : ${projectName}`, 20, 50);
            doc.text(`Client : ${clientName}`, 20, 60);
            doc.text(`Attention: ${document.getElementById('clientContact').value}`, 20, 70);
            doc.text(`Contact : ${document.getElementById('clientPhone').value}`, 20, 80);
            
            doc.text('Based on 1 week standby for support crew', 20, 95);
            doc.text('Based on SGD currency and all terms and conditions on quote.', 20, 105);
            doc.text(`Usage: ${document.getElementById('usageRights').value}`, 20, 115);
            
            // Cost breakdown table - exactly like your format
            let yPos = 135;
            doc.setFont(undefined, 'bold');
            doc.text('SUMMARY OF PRODUCTION COSTS:', 20, yPos);
            yPos += 15;
            
            doc.setFont(undefined, 'normal');
            const categories = [
                ['1. Pre-production Cost', 'preproduction'],
                ['2. Production Unit', 'production'],
                ['3. Overtime', 'overtime'],
                ['4. Equipment', 'equipment'],
                ['5. Data Management', 'datamanagement'],
                ['6. Location and Studio Rental', 'location'],
                ['7. Props and settings', 'props'],
                ['8. Talents', 'talents'],
                ['9. Wardrobes', 'wardrobes'],
                ['10. Catering', 'catering'],
                ['11. Transportation', 'transportation'],
                ['12. Post production & music production', 'postproduction']
            ];
            
            categories.forEach(([label, id]) => {
                const value = document.getElementById(id).value || '0';
                doc.text(label, 20, yPos);
                doc.text(`$ ${parseFloat(value).toLocaleString('en-SG')}`, 150, yPos);
                yPos += 12;
            });
            
            // Totals
            yPos += 10;
            const totalCost = categories.reduce((sum, [, id]) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = totalCost * (discountPercent / 100);
            const subTotal = totalCost - discountAmount;
            const gst = subTotal * 0.09;
            const grandTotal = subTotal + gst;
            
            doc.text('Total Cost of Production', 20, yPos);
            doc.text(`$ ${totalCost.toLocaleString('en-SG')}`, 150, yPos);
            yPos += 12;
            
            if (discountPercent > 0) {
                doc.text(`Discount ${discountPercent}%`, 20, yPos);
                doc.text(`-$ ${discountAmount.toLocaleString('en-SG')}`, 150, yPos);
                yPos += 12;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('SUB TOTAL', 20, yPos);
            doc.text(`$ ${subTotal.toLocaleString('en-SG')}`, 150, yPos);
            yPos += 12;
            
            doc.text('GST 9%', 20, yPos);
            doc.text(`$ ${gst.toLocaleString('en-SG')}`, 150, yPos);
            yPos += 12;
            
            doc.text('GRAND TOTAL', 20, yPos);
            doc.text(`$ ${grandTotal.toLocaleString('en-SG')}`, 150, yPos);
            
            // Add new page for T&Cs
            doc.addPage();
            addTermsAndConditions(doc);
            
            // Save
            doc.save(`${projectName.replace(/\s+/g, '_')}_Quotation.pdf`);
        }

        function addTermsAndConditions(doc) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('TERMS AND CONDITIONS:', 20, 25);
            
            const terms = [
                '1. This quotation is valid for 30 days from the date hereof.',
                '2. Both parties agree that your acceptance of this quotation shall constitute a formal and binding contract.',
                '3. Payment terms: 50% upon job confirmation, 30% upon first draft, 20% upon completion.',
                '4. Job cancellation prior to principal photography will incur costs:',
                '   ‚Ä¢ 21 days before: 100% Pre-Production + 25% Production',
                '   ‚Ä¢ 7 days before: 100% Pre-Production + 100% Production',
                '5. Overtime fees: [Normal crew rate/10 x (number of hours OT) x 2]',
                '6. This quotation excludes contingency shoot days due to circumstances beyond our control.',
                '7. Media usage describes where and how long the video can be seen.',
                '8. All prices quoted are in Singapore Dollars.',
                '9. Epitome Productions Pte Ltd will possess all ownership rights to footage created.',
                '10. Payment details: DBS Current Account 0179051975',
                '11. Late payment subject to 2% per annum interest charges.'
            ];
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            let yPos = 45;
            
            terms.forEach(term => {
                doc.text(term, 20, yPos);
                yPos += 12;
            });
        }

        function saveProject() {
            const projectName = document.getElementById('projectName').value;
            if (!projectName) {
                alert('Please enter a project name before saving.');
                return;
            }
            
            // Gather all data
            const projectData = {
                name: projectName,
                client: document.getElementById('clientName').value,
                contact: document.getElementById('clientContact').value,
                phone: document.getElementById('clientPhone').value,
                usage: document.getElementById('usageRights').value,
                mode: currentMode,
                costs: {},
                crew: [],
                discountPercent: document.getElementById('discountPercent').value,
                usageLoading: document.getElementById('usageLoading').value,
                geoLoading: document.getElementById('geoLoading').value,
                savedAt: new Date().toISOString()
            };
            
            // Save costs
            const categories = ['preproduction', 'production', 'overtime', 'equipment', 
                             'datamanagement', 'location', 'props', 'talents', 'wardrobes', 
                             'catering', 'transportation', 'postproduction'];
            
            categories.forEach(category => {
                projectData.costs[category] = document.getElementById(category).value;
            });
            
            // Save crew data
            CREW_STRUCTURE.forEach((crew, index) => {
                projectData.crew.push({
                    role: crew.role,
                    prep: document.getElementById(`prep-${index}`).value,
                    shoot: document.getElementById(`shoot-${index}`).value,
                    wrap: document.getElementById(`wrap-${index}`).value,
                    rate: document.getElementById(`rate-${index}`).value
                });
            });
            
            // Save to localStorage
            localStorage.setItem(`epitome_business_${projectName}`, JSON.stringify(projectData));
            alert(`Project '${projectName}' saved successfully!`);
        }

        function loadProject() {
            // Get list of saved projects
            const projects = [];
            for (let key in localStorage) {
                if (key.startsWith('epitome_business_')) {
                    projects.push(key.replace('epitome_business_', ''));
                }
            }
            
            if (projects.length === 0) {
                alert('No saved projects found.');
                return;
            }
            
            const projectName = prompt(`Select project to load:\n\n${projects.join('\n')}\n\nEnter project name:`);
            if (projectName && projects.includes(projectName)) {
                const projectData = JSON.parse(localStorage.getItem(`epitome_business_${projectName}`));
                loadProjectData(projectData);
                alert(`Project '${projectName}' loaded successfully!`);
            }
        }

        function loadProjectData(data) {
            // Load basic project info
            document.getElementById('projectName').value = data.name || '';
            document.getElementById('clientName').value = data.client || '';
            document.getElementById('clientContact').value = data.contact || '';
            document.getElementById('clientPhone').value = data.phone || '';
            document.getElementById('usageRights').value = data.usage || '';
            
            // Load costs
            if (data.costs) {
                Object.entries(data.costs).forEach(([key, value]) => {
                    const input = document.getElementById(key);
                    if (input) input.value = value;
                });
            }
            
            // Load crew data
            if (data.crew) {
                data.crew.forEach((crewData, index) => {
                    document.getElementById(`prep-${index}`).value = crewData.prep;
                    document.getElementById(`shoot-${index}`).value = crewData.shoot;
                    document.getElementById(`wrap-${index}`).value = crewData.wrap;
                    document.getElementById(`rate-${index}`).value = crewData.rate;
                    updateCrewCost(index);
                });
            }
            
            // Load discount and loading
            document.getElementById('discountPercent').value = data.discountPercent || '0';
            document.getElementById('usageLoading').value = data.usageLoading || '0';
            document.getElementById('geoLoading').value = data.geoLoading || '0';
            
            // Set mode
            if (data.mode) {
                setMode(data.mode);
            }
            
            calculateTotals();
        }

        function loadSample() {
            const sampleData = {
                name: "Commercial Project Sample",
                client: "Sample Client Pte Ltd",
                contact: "John Doe",
                phone: "+65 9123 4567",
                usage: "Digital, Social, Singapore - 12 months",
                mode: "cost-up",
                costs: {
                    preproduction: 2000,
                    production: 25000,
                    overtime: 0,
                    equipment: 8000,
                    datamanagement: 400,
                    location: 5000,
                    props: 3000,
                    talents: 12000,
                    wardrobes: 2000,
                    catering: 1500,
                    transportation: 2500,
                    postproduction: 18000
                },
                discountPercent: 5,
                usageLoading: 10,
                geoLoading: 0
            };
            
            loadProjectData(sampleData);
            alert('Sample project loaded! This shows a typical $80K commercial project with 5% discount and 10% usage loading.');
        }
    </script>
</body>
</html>